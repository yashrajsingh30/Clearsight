services:
  app:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: clearsight_backend
    ports:
      - "5000:5000"
    volumes:
      # Development volume mounting
      - ${PWD}/backend:/app/backend:${MOUNT_TYPE:-rw}
      - uploads_data:/app/uploads
      - logs_data:/app/logs
      - screenshot_data:/app/screenshots
    environment:
      #- MODE=${MODE:-production}
      - MODE=${MODE:-development}
      #- FLASK_DEBUG=${FLASK_DEBUG:-False}
      - FLASK_DEBUG=${FLASK_DEBUG:-True}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_HOST=redis
      - MONGO_URI=mongodb://mongodb:27017/clearsight
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5000}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - MAX_CONTENT_LENGTH=${MAX_CONTENT_LENGTH:-16777216}
      - ENABLE_DETAILED_LOGGING=${ENABLE_DETAILED_LOGGING:-True}
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY}
      - ENABLE_THREAT_INTELLIGENCE=${ENABLE_THREAT_INTELLIGENCE:-True}
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      sandbox:
        condition: service_started
    restart: unless-stopped
    networks:
      - clearsight-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  celery_worker:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: clearsight_worker
    working_dir: /app/backend
    volumes:
      - ${PWD}/backend:/app/backend:${MOUNT_TYPE:-rw}
      - uploads_data:/app/uploads
      - logs_data:/app/logs
      - screenshot_data:/app/screenshots
    environment:
      - MODE=${MODE:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_HOST=redis
      - MONGO_URI=mongodb://mongodb:27017/clearsight
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - ENABLE_DETAILED_LOGGING=${ENABLE_DETAILED_LOGGING:-True}
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY}
      - ENABLE_THREAT_INTELLIGENCE=${ENABLE_THREAT_INTELLIGENCE:-True}
    command: >
      sh -c "
        echo 'Starting Celery worker...' &&
        sleep 5 &&
        celery -A app.celery worker --loglevel=info --concurrency=2
      "
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      app:
        condition: service_healthy
      sandbox: 
        condition: service_started
    restart: unless-stopped
    networks:
      - clearsight-network
    healthcheck:
      test: ["CMD", "celery", "-A", "app.celery", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  redis:
    image: redis:7-alpine
    container_name: clearsight_redis
    command: >
      redis-server 
      --appendonly yes 
      --appendfsync everysec 
      --maxmemory 256mb 
      --maxmemory-policy allkeys-lru
      --save 900 1 
      --save 300 10 
      --save 60 10000
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"  # Expose for development debugging
    restart: unless-stopped
    networks:
      - clearsight-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  mongodb:
    image: mongo:7.0
    container_name: clearsight_mongo
    ports:
      - "27017:27017"  # Expose for development debugging
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=clearsight
    restart: unless-stopped
    networks:
      - clearsight-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
  
  sandbox:
    build: ./sandbox
    container_name: clearsight_sandbox
    ports:
      - "3001:3001"
    volumes:
      # Mount a shared volume for screenshots
      - screenshot_data:/app/screenshots
    networks:
      - clearsight-network
    restart: unless-stopped

volumes:
  uploads_data:
    driver: local
  logs_data:
    driver: local
  redis_data:
    driver: local
  mongodb_data:
    driver: local
  screenshot_data:
    driver: local

networks:
  clearsight-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16 